<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø³Ú©Ø§Ù†Û•Ø±ÛŒ Ø²ÛŒØ±Û•Ú© | Smart School</title>
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: white; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 380px; background: var(--card); padding: 25px; border-left: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.3); }
        .sidebar h2 { color: var(--accent); text-align: center; margin-bottom: 20px; font-size: 1.4rem; border-bottom: 2px solid #334155; padding-bottom: 10px; }
        
        .stat-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; display: flex; justify-content: space-around; }
        .stat-item span { display: block; font-size: 1.5rem; font-weight: bold; }

        #absentList { flex-grow: 1; overflow-y: auto; list-style: none; padding: 0; margin-top: 10px; }
        .absent-item { background: rgba(239, 68, 68, 0.1); margin-bottom: 10px; padding: 12px 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-right: 4px solid var(--danger); animation: fadeIn 0.5s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .stu-display { background: var(--card); width: 420px; padding: 40px; border-radius: 35px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .stu-img { width: 180px; height: 180px; border-radius: 50%; border: 6px solid var(--accent); object-fit: cover; background: #000; margin-bottom: 20px; }
        
        .btn { color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-arduino { background: #475569; position: absolute; top: 30px; left: 30px; border: 1px dashed var(--accent); }
        .btn-finish { background: var(--danger); width: 100%; margin-top: 15px; padding: 18px; font-size: 1.1rem; }
        #scanFeedback { font-size: 1.2rem; min-height: 30px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>âš ï¸ Ù„ÛŒØ³ØªÛŒ ØºØ§ÛŒØ¨Ø§Ù†</h2>
        <div class="stat-box">
            <div class="stat-item"><span id="pCount" style="color:var(--success)">0</span> Ø¦Ø§Ù…Ø§Ø¯Û•</div>
            <div class="stat-item"><span id="aCount" style="color:var(--danger)">0</span> ØºØ§ÛŒØ¨</div>
        </div>
        <div id="absentList"></div>
        <button class="btn btn-finish" onclick="finishDay()">ğŸ Ú©Û†ØªØ§ÛŒÛŒÙ‡ÛÙ†Ø§Ù† Ø¨Û• Ø¯Û•ÙˆØ§Ù…</button>
    </div>

    <div class="main-content">
        <button class="btn btn-arduino" id="connBtn" onclick="toggleArduino()">ğŸ”Œ Ù¾Û•ÛŒÙˆÛ•Ø³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¦Ø§Ø±Ø¯ÛŒÙ†Û†</button>
        
        <div class="stu-display">
            <img id="stuImg" src="images/default.jpg" class="stu-img" onerror="this.src='https://via.placeholder.com/180?text=No+Photo'">
            <h1 id="stuName" style="margin: 10px 0; font-size: 2.2rem;">Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª</h1>
            <p id="stuClass" style="color:#94a3b8; font-size: 1.3rem;">ØªÚ©Ø§ÛŒÛ• Ú©Ø§Ø±ØªÛ•Ú©Û• Ø³Ú©Ø§Ù† Ø¨Ú©Û•</p>
            <div id="scanFeedback"></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCNE5SrgyfTV6_6fieRCLaKPyAGk0ox-FM", 
        authDomain: "school-system-4d4da.firebaseapp.com", 
        projectId: "school-system-4d4da", 
        appId: "1:554610137178:web:4b549d67471722030da063" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let allStudents = [];
    let today = new Date().toISOString().split('T')[0];
    let currentAbsentList = [];

    async function init() {
        // Ù¡. Ù‡ÛÙ†Ø§Ù†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ù‚ÙˆØªØ§Ø¨ÛŒØ§Ù† Ø¨Û† Ù†Ø§Ø³ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú©Ø§Ø±ØªÛ•Ú©Ø§Ù†
        const snap = await getDocs(collection(db, "students"));
        allStudents = snap.docs.map(d => ({
            ...d.data(), 
            searchID: String(d.data().cardID).trim().toUpperCase() 
        }));
        
        // Ù¢. Ú†Ø§ÙˆØ¯ÛØ±ÛŒ Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û•Ø´ÛŒ "Present" Ø¨Û† Ú•Û†Ú˜ÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§Ùˆ
        const presentRef = collection(db, "Attendance", today, "Present");
        onSnapshot(presentRef, (s) => {
            const presentIDs = s.docs.map(d => String(d.id).trim().toUpperCase());
            render(presentIDs);
        });
    }

    function render(presentIDs) {
        const absentUI = document.getElementById('absentList');
        absentUI.innerHTML = "";
        currentAbsentList = [];
        
        allStudents.forEach(st => {
            if (!presentIDs.includes(st.searchID)) {
                currentAbsentList.push(st);
                const li = document.createElement('div');
                li.className = "absent-item";
                li.innerHTML = `<span>${st.name}</span> <button class="btn" style="padding:5px 10px; font-size:0.7rem; background:var(--success)" onclick="window.processScan('${st.searchID}')">Ø¦Ø§Ù…Ø§Ø¯Û•</button>`;
                absentUI.appendChild(li);
            }
        });

        document.getElementById('pCount').innerText = presentIDs.length;
        document.getElementById('aCount').innerText = currentAbsentList.length;
    }

    window.processScan = async (scannedID) => {
        const id = String(scannedID).trim().toUpperCase();
        const st = allStudents.find(s => s.searchID === id);

        if (st) {
            document.getElementById('stuName').innerText = st.name;
            document.getElementById('stuClass').innerText = "Ù¾Û†Ù„ÛŒ: " + (st.class || "");
            document.getElementById('stuImg').src = `images/${st.photoName || "default.jpg"}`;
            const feedback = document.getElementById('scanFeedback');
            feedback.innerText = "Ø¦Ø§Ù…Ø§Ø¯Û• Ú©Ø±Ø§ âœ…";
            feedback.style.color = "var(--success)";
            setTimeout(() => feedback.innerText = "", 3000);

            // ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù† Ù„Û•: Attendance -> [Today] -> Present -> [CardID]
            const docRef = doc(db, "Attendance", today, "Present", st.cardID.toString());
            await setDoc(docRef, { 
                name: st.name, 
                class: st.class || "", 
                time: new Date().toLocaleTimeString('en-GB') 
            });
        } else {
            const feedback = document.getElementById('scanFeedback');
            feedback.innerText = "Ø¦Ø§ÛŒØ¯ÛŒ (" + id + ") ØªÛ†Ù…Ø§Ø± Ù†ÛŒÛŒÛ•! âŒ";
            feedback.style.color = "var(--danger)";
        }
    };

    window.finishDay = async () => {
        if (currentAbsentList.length === 0) return alert("Ù‡ÛŒÚ† ØºØ§ÛŒØ¨ÛÚ© Ù†ÛŒÛŒÛ•.");
        if (confirm(`Ø¦Ø§ÛŒØ§ Ø¯ÚµÙ†ÛŒØ§ÛŒØŸ ${currentAbsentList.length} Ù‚ÙˆØªØ§Ø¨ÛŒ ØºØ§ÛŒØ¨ Ø¯Û•Ú©Ø±ÛÙ†.`)) {
            for (const st of currentAbsentList) {
                // ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù† Ù„Û•: Attendance -> [Today] -> Absent -> [CardID]
                const docRef = doc(db, "Attendance", today, "Absent", st.cardID.toString());
                await setDoc(docRef, {
                    name: st.name,
                    class: st.class || "",
                    status: "ØºØ§ÛŒØ¨"
                });
            }
            alert("ØªÛ•ÙˆØ§Ùˆ! Ù‡Û•Ù…ÙˆÙˆ ØºØ§ÛŒØ¨Û•Ú©Ø§Ù† Ù„Û• Ø¨Û•Ø´ÛŒ Absent ØªÛ†Ù…Ø§Ø± Ú©Ø±Ø§Ù†.");
        }
    };

    init();
</script>

<script>
    let port;
    let reader;

    async function toggleArduino() {
        const btn = document.getElementById('connBtn');
        if (!port) {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                btn.innerText = "âŒ Ø¯ÛŒØ³Ú©Û†Ù†ÛÚ©Øª (Ø¦Ø§Ø±Ø¯ÛŒÙ†Û†)";
                btn.style.background = "var(--danger)";
                readSerial();
            } catch (e) { alert("Ù¾Û•ÛŒÙˆÛ•Ø³Øª Ù†Û•Ú©Ø±Ø§!"); }
        } else {
            // Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ú•ÛÚ¯Û• Ø¨Û† Ø¯ÛŒØ³Ú©Û†Ù†ÛÚ©Øª Ú©Ø±Ø¯Ù† Ø¨Û•Ø¨Û Ù‚ÙˆÙÚµ Ø¨ÙˆÙˆÙ†ÛŒ Ù¾Û†Ø±ØªÛ•Ú©Û•
            if(confirm("Ø¦Ø§ÛŒØ§ Ø¯Û•ØªÛ•ÙˆÛØª Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒÛŒÛ•Ú©Û• Ø¨Ù¾Ú†Ú•ÛÙ†ÛŒØªØŸ")) {
                location.reload();
            }
        }
    }

    async function readSerial() {
        const decoder = new TextDecoder();
        while (port && port.readable) {
            reader = port.readable.getReader();
            try {
                let serialBuf = "";
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    serialBuf += decoder.decode(value);
                    if (serialBuf.includes("\n") || serialBuf.includes("\r")) {
                        const cleanID = serialBuf.replace(/[^a-zA-Z0-9]/g, "").trim().toUpperCase();
                        if (cleanID && window.processScan) window.processScan(cleanID);
                        serialBuf = "";
                    }
                }
            } catch (e) { break; } 
            finally { reader.releaseLock(); }
        }
    }
</script>
</body>
</html>
